<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>商品管理</title>
    <style>
        table{
            width:100%;
            border-collapse:collapse;
        }
        table td{
            border:1px solid green;
            text-align:center;
        }
    </style>
    <script src="baiduTemplate.js"></script>
</head>
<body>
<div>
    <form id="gdsForm" name="myGds">
    	<input type="text" name="id" hidden />
        <p>商品名称：<input type="text" name = "gdsName"></p>
        <p>商品价格：<input type="text" name = "gdsPrice"></p>
        <p>商品排序：<input type="text" name = "orderBy"></p>
        
        <p>商品图片：<input onchange="changeImg(this)" type="file" name = "gdsPic">
            <img id="myPic" width="80" src="" alt="">


        </p>
        <p><input type="button" name="btn" value="提交"></p>
    </form>
</div>
<div id="myApp">

</div>
<script type="text/html" id="tp">
    <table>
        <tr>
            <td>ID</td>
            <td>商品名称</td>
            <td>商品价格</td>
            <td>商品排序</td>
            <td>商品图片</td>
            <td>添加时间</td>
            <td>操作</td>
        </tr>
        <%for(var i=0;i<gdsList.length;i++){%>
        <tr>
            <td><%=gdsList[i]._id%></td>
            <td><%=gdsList[i].gdsName%></td>
            <td><%=gdsList[i].gdsPrice%></td>
            <td><%=gdsList[i].orderBy%></td>
            <td><img width="50" src="<%=gdsList[i].gdsPic%>" alt=""></td>
            
            <td><%=gdsList[i].addTime%></td>
            <td>
            	<a href="javascript:;" onclick="gdsInfoById('<%=gdsList[i]._id%>')">修改</a>
            	<a href="javascript:;" onclick="deleteGdsById('<%=gdsList[i]._id%>')">删除</a>
            </td>
        </tr>
        <%}%>
    </table>
</script>
</body>
<script>
    var btn = document.querySelector("input[name=btn]");
    var myPic = document.querySelector("#myPic");
    var advForm = document.querySelector("#gdsForm");
    getGdsList();
    btn.onclick = function () {
        //FormData
        var formdata = new FormData(document.querySelector("#gdsForm"));
        var xhr = new XMLHttpRequest();
       if(btn.value === "修改"){
       	xhr.open("put","/goods/"+document.myGds.id.value)
       }else{
       	xhr.open("post","/goods");
       }
        xhr.send(formdata);
        xhr.onload = function () {
            //console.log(xhr.responseText);
              var obj = JSON.parse( xhr.responseText )
              alert(obj.msg)
              advForm.reset();
              myPic.style.display="none";
              getGdsList();
              btn.value = "提交"
         }
    }
    /*********************图片预览**********************************/
    function changeImg(_this) {
        var reader = new FileReader();
        reader.readAsDataURL(_this.files[0]);
        reader.onload=function (e) {
            myPic.src=e.target.result;
            console.log(e.target.result);
        }
    }
    /*********************删除商品列表***************************************/
    function deleteGdsById(id) {
        var xhr = new XMLHttpRequest();
        xhr.open("delete","/goods/"+id);
        xhr.send();
        xhr.onload=function (ev) {
          getGdsList();
        }
    }
    /*********************显示商品列表***************************************/

    function getGdsList(){
        var xhr = new XMLHttpRequest();
        xhr.open("get","/goods");
        xhr.send();
        xhr.onload=function (ev) {
            var obj = JSON.parse(xhr.responseText);
            document.querySelector("#myApp").innerHTML = baidu.template("tp",obj);
        }
    }
    /********************根据ID获得商品列表***************************************/
    function gdsInfoById(id){
    	var xhr = new XMLHttpRequest();
    	xhr.open("get","/gdsInfoById?id="+id);
    	xhr.send();
    	xhr.onload = function(){
    		var obj = JSON.parse(xhr.responseText);
    		document.myGds.id.value = obj.gdsInfo._id;
    		document.myGds.gdsName.value = obj.gdsInfo.gdsName;
    		document.myGds.gdsPrice.value = obj.gdsInfo.gdsPrice;
    		document.myGds.orderBy.value = obj.gdsInfo.orderBy;
    		myPic.src = obj.gdsInfo.gdsPic;
    		btn.value = "修改";
    	}
    }
</script>
</html>