<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>广告管理</title>
    <style>
        table{
            width:100%;
            border-collapse:collapse;
        }
        table td{
            border:1px solid green;
            text-align:center;
        }
    </style>
    <script src="baiduTemplate.js"></script>
</head>
<body>
<div>
    <form id="advForm" name="myAdv">
    	<input type="text" name="id" hidden/>
        <p>广告标题：<input type="text" name = "advName"></p>
        <p>广告链接：<input type="text" name = "advHref"></p>
        <p>广告排序：<input type="text" name = "orderBy"></p>
        <p>广告类别： <select name="advType">
            <option value="1">轮播图</option>
            <option value="2">轮播图底部广告</option>
            <option value="3">热门手机回收</option>
            <option value="4">优品精选</option>
        </select></p>
        <p>广告图片：<input onchange="changeImg(this)" type="file" name = "advPic">
            <img id="myPic" width="200" src="" alt="">
       </p>
        <p><input type="button" name="btn" value="提交"></p>
    </form>
</div>
<div id="myApp">

</div>
<script type="text/html" id="tp">
    <table>
        <tr>
            <td>ID</td>
            <td>广告标题</td>
            <td>广告链接</td>
            <td>广告类型</td>
            <td>广告图片</td>
            <td>广告排序</td>
            <td>添加时间</td>
            <td>操作</td>
        </tr>
        <%for(var i=0;i<advList.length;i++){%>
        <tr>
            <td><%=advList[i]._id%></td>
            <td><%=advList[i].advName%></td>
            <td><%=advList[i].advHref%></td>
            <td><%=advTypeEnum[advList[i].advType]%></td>
            <td><img width="100" src="<%=advList[i].advPic%>" alt=""></td>
            <td><%=advList[i].orderBy%></td>
            <td><%=advList[i].addTime%></td>
            <td>
            	<a href="javascript:;" onclick="advInfoById('<%=advList[i]._id%>')">修改</a>
            	<a href="javascript:;" onclick="deleteAdvById('<%=advList[i]._id%>')">删除</a>
            </td>
        </tr>
        <%}%>
    </table>
</script>
</body>
<script>
    var btn = document.querySelector("input[name=btn]");
    var myPic = document.querySelector("#myPic");
    var advForm = document.querySelector("#advForm");
    getAdvList();
    btn.onclick = function () {
        //FormData
        var formdata = new FormData(document.querySelector("#advForm"));
        var xhr = new XMLHttpRequest();
        if(btn.value==="修改"){
        	xhr.open("put","/adv/"+document.myAdv.id.value)
        }else{
        	xhr.open("post","/adv");
        }
        
        xhr.send(formdata);
        xhr.onload = function () {
            //console.log(xhr.responseText);
            var obj = JSON.parse(xhr.responseText)
            alert(obj.msg)
            advForm.reset(); 
            myPic.style.display="none";
            getAdvList();
             btn.value = "提交";
        }
       
    }
    /*********************图片预览**********************************/
    function changeImg(_this) {
        var reader = new FileReader();
        reader.readAsDataURL(_this.files[0]);
        reader.onload=function (ev) {
            myPic.src=ev.target.result;
            console.log(ev.target.result);
        }
    }
    /*********************显示广告列表***************************************/
    function deleteAdvById(id) {
        var xhr = new XMLHttpRequest();
        xhr.open("delete","/adv/"+id);
        xhr.send();
        xhr.onload=function (ev) {
          getAdvList();
        }
    }
    /*********************显示广告列表***************************************/

    function getAdvList(){
        var xhr = new XMLHttpRequest();
        xhr.open("get","/adv");
        xhr.send();
        xhr.onload=function (ev) {
            var obj = JSON.parse(xhr.responseText);
            document.querySelector("#myApp").innerHTML = baidu.template("tp",obj);
        }
    }
     /*********************根据ID获得广告信息***************************************/
    
   function advInfoById(id){
   	var xhr = new XMLHttpRequest();
   	xhr.open("get","/advInfoById?id="+id);
   	xhr.send();
   	xhr.onload = function(){
   		var obj = JSON.parse(xhr.responseText);
   		document.myAdv.advName.value= obj.advInfo.advName;
   		document.myAdv.advHref.value = obj.advInfo.advHref;
   		document.myAdv.advType.value = obj.advInfo.advType;
   		document.myAdv.orderBy.value = obj.advInfo.orderBy;
   		document.myAdv.id.value = obj.advInfo._id;
   		myPic.src = obj.advInfo.advPic;
   		btn.value = "修改";
   	}
   }
</script>
</html>